"use strict";angular.module("Authentication",[]);var app=angular.module("notebookWebApp",["Authentication","ngAnimate","ngCookies","ngRoute","ngSanitize","angular-websocket","ui.ace","ui.bootstrap","ngTouch","ngDragDrop"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",hideMenus:!0}).when("/notebook/:noteId/paragraph/:paragraphId?",{templateUrl:"views/main.html"}).otherwise({redirectTo:"/login"})}]).run(["$rootScope","$location","$cookieStore","$http",function(a,b,c,d){a.globals=c.get("globals")||{},a.globals.currentUser&&(d.defaults.headers.common.Authorization="Basic "+a.globals.currentUser.authdata),a.$on("$locationChangeStart",function(c,d,e){"/login"===b.path()||a.globals.currentUser||b.path("/login")})}]);angular.module("notebookWebApp").controller("MainCtrl",["$scope","$rootScope","$window",function(a,b,c){b.connected=!0,a.looknfeel="simple",a.lastChangedNotebookId="",a.lastChangedNotebookDate="";var d=function(){a.asIframe=c.location.href.indexOf("asIframe")>-1?!0:!1};d(),b.$on("setIframe",function(b,c){b.defaultPrevented||(a.asIframe=c,b.preventDefault())}),b.$on("setLookAndFeel",function(b,c){!b.defaultPrevented&&c&&""!==c&&(a.looknfeel=c,b.preventDefault())}),b.$on("changeActiveNotebook",function(c,d){(a.lastChangedNotebookId!==d.id||a.lastChangedNotebookDate!==d.date)&&(a.lastChangedNotebookId=d.id,a.lastChangedNotebookDate=d.date,b.$emit("rootChangeActiveNotebook",d))})}]),angular.module("notebookWebApp").controller("TopBarCtrl",["$scope","$rootScope","AuthenticationService","$modal","$http","baseUrlSrv",function(a,b,c,d,e,f){a.logout=function(){c.ClearCredentials()},a.openHelp=function(){d.open({animation:!0,templateUrl:"/views/modal-shortcut.html",windowClass:"center-modal"})},a.openSettings=function(){d.open({animation:!0,templateUrl:"/views/modal-settings.html",windowClass:"center-modal"})},b.$on("openPropertiesEditor",function(b,c){a.openPropertiesEditor(c)}),a.openPropertiesEditor=function(a){console.log(a);d.open({animation:!0,controller:"ModalEditCtrl",templateUrl:"/views/modal-editor.html",windowClass:"center-modal",resolve:{properties:function(){return e.get(f.getRestApiBase()+"/interpreter/settings/editor?path="+a).success(function(a,b,c,d){console.log("success")}).error(function(a,b,c,d){console.log("Error %o %o",b,a.message)})},resolvePath:function(){return a}}})}}]),angular.module("notebookWebApp").controller("ModalEditorCtrl",["$modalInstance","properties","resolvePath","$http",function(a,b,c,d){$scope.file={},$scope.file.text=b.data.body,$scope.saveEditorSettings=function(){var a=c+"~"+$scope.file.text;console.log("saveEditorSettings"),d.put(getRestApiBase()+"/interpreter/settings/editor",a).success(function(a,b,c,d){alert("Editor settings saved")}).error(function(a,b,c,d){alert("Error "+b+" "+a.message),console.log("Error %o %o",b,a.message)})},$scope.ok=function(){a.close()},$scope.cancel=function(){a.dismiss("cancel")}}]),angular.module("notebookWebApp").controller("ModalSettingsCtrl",["$scope","$modal","$http","baseUrlSrv",function(a,b,c,d){return a.showCrossdataProperties=!1,a.showIngestionProperties=!1,a.showCassandraProperties=!1,a.interpreterSettings="",{getCrossdataInterpreterSettings:function(){a.showCrossdataProperties?a.showCrossdataProperties=!1:(a.showCrossdataProperties=!0,c.get(d.getRestApiBase()+"/interpreter/settings/list?nameFile=driver-application").success(function(b){var c=b.body;a.interpreterSettingsCrossdata=c}).error(function(a,b){console.log("Error %o %o",b,a.message)}))},saveCrossdataInterpreterSettings:function(){c.put(d.getRestApiBase()+"/interpreter/settings/crossdata"+a.interpreterSettingsCrossdata).success(function(a){alert("Crossdata settings saved")}).error(function(a,b){alert("Error "+b+" "+a.message)})},getIngestionInterpreterSettings:function(){a.showIngestionProperties?a.showIngestionProperties=!1:(a.showIngestionProperties=!0,c.get(d.getRestApiBase()+"/interpreter/settings/list?nameFile=ingestion").success(function(b){var c=b.body;a.interpreterSettingsIngestion=c}).error(function(a,b){console.log("Error %o %o",b,a.message)}))},getCassandraInterpreterSettings:function(){a.showCassandraProperties?a.showCassandraProperties=!1:(a.showCassandraProperties=!0,c.get(d.getRestApiBase()+"/interpreter/settings/list?nameFile=cassandra").success(function(b){var c=b.body;a.interpreterSettingsCassandra=c}).error(function(a,b){console.log("Error %o %o",b,a.message)}))},saveIngestionInterpreterSettings:function(){console.log("saveIngestionIntepreterSettings"),c.put(d.getRestApiBase()+"/interpreter/settings/ingestion",a.interpreterSettingsIngestion).success(function(){alert("Ingestion settings saved"),console.log("Settings saved")}).error(function(a,b){alert("Error "+b+" "+a.message),console.log("Error %o %o",b,a.message)})},restartInterpreterConnection:function(){console.log("restartInterpreterConnection")},resetToDefault:function(){console.log("reset to default settings"),c.put(d.getRestApiBase()+"/interpreter/reset",!0).success(function(){console.log("Settings restored to default"),a.getInterpreterSettings()}).error(function(a,b){console.log("Error %o %o",b,a.message)})},ok:function(){b.close()},cancel:function(){b.dismiss("cancel")},saveCassandraInterpreterSettings:function(){c.put(d.getRestApiBase()+"/interpreter/settings/cassandra",a.interpreterSettingsCassandra).success(function(a){alert("cassandra settings saved")}).error(function(a,b){alert("Error "+b+" "+a.message)})}}}]),angular.module("notebookWebApp").controller("NotebookSelectorCtrl",["$scope","$rootScope","$http","websocketMsgSrv",function(a,b,c,d){a.active="none",a.activeDate="none",a.activate=function(c,d){c!==a.active?(b.$emit("changeActiveNotebook",{id:c,date:d}),a.active=c,a.activeDate=d):(b.$emit("changeActiveNotebook",{id:"none",date:"none"}),a.active="none",a.activeDate="none")},b.$on("setNoteMenu",function(b,c){a.notes=c});var e=function(){d.getNotebookList()};e(),a.createNewNote=function(){d.createNotebook()},a.refreshNoteList=function(){d.getNotebookList()},a.removeNote=function(c){d.deleteNotebook(c),a.active="none",a.activeDate="none",b.$emit("changeActiveNotebook",{id:"none",date:"none"})}}]),angular.module("Authentication").controller("LoginCtrl",["$scope","$rootScope","$location","AuthenticationService",function(a,b,c,d){d.ClearCredentials(),a.login=function(){a.dataLoading=!0,d.Login(a.username,a.password,function(b){b.success?(d.SetCredentials(a.username,a.password),c.path("/")):(a.error=b.message,a.dataLoading=!1)})}}]),angular.module("notebookWebApp").controller("NotebookCtrl",["$scope","$http","$route","$routeParams","$location","$rootScope","websocketMsgSrv","baseUrlSrv","$timeout",function(a,b,c,d,e,f,g,h,i){a.note=null,a.settings={},a.settings.interpreter="crossdata",a.settings.interpreters=["crossdata","ingestion","spark","spark-sql","markdown","streaming","shell"],a.active="none",a.showEditor=!1,a.editorToggled=!0,a.tableToggled=!0,a.looknfeelOption=["default","simple"],a.exportFilename="mynotebook",a.importPath="full/path/to/file",a.cronOption=[{name:"None",value:void 0},{name:"1m",value:"0 0/1 * * * ?"},{name:"5m",value:"0 0/5 * * * ?"},{name:"1h",value:"0 0 0/1 * * ?"},{name:"3h",value:"0 0 0/3 * * ?"},{name:"6h",value:"0 0 0/6 * * ?"},{name:"12h",value:"0 0 0/12 * * ?"},{name:"1d",value:"0 0 0 * * ?"}],a.getCronOptionNameFromValue=function(b){if(!b)return"";for(var c in a.cronOption)if(a.cronOption[c].value===b)return a.cronOption[c].name;return b};var j=function(a){g.getNotebook(a)};f.$on("rootChangeActiveNotebook",function(b,c){c.id!==a.active&&(a.active=c.id,"none"!==c.id&&j(c.id))}),a.runNote=function(){var b=confirm("Run all paragraphs?");b&&_.forEach(a.note.paragraphs,function(a,b){angular.element("#"+a.id+"_paragraphColumn_main").scope().runParagraph(a.text)})},a.toggleAllEditor=function(){a.editorToggled?f.$broadcast("closeEditor"):f.$broadcast("openEditor"),a.editorToggled=!a.editorToggled},a.showAllEditor=function(){f.$broadcast("openEditor")},a.hideAllEditor=function(){f.$broadcast("closeEditor")},a.toggleAllTable=function(){a.tableToggled?f.$broadcast("closeTable"):f.$broadcast("openTable"),a.tableToggled=!a.tableToggled},a.showAllTable=function(){f.$broadcast("openTable")},a.hideAllTable=function(){f.$broadcast("closeTable")},a.exportNote=function(b){console.log("note id = "+b+" filename "+a.exportFilename),g.exportNote(a.note.id,a.exportFilename)},a.importNote=function(){console.log(" filename "+a.importPath),g.importNote(a.importPath)},a.fileNameChanged=function(a){console.log(a.files)},a.isNoteRunning=function(){var b=!1;if(!a.note)return!1;for(var c=0;c<a.note.paragraphs.length;c++)if("PENDING"===a.note.paragraphs[c].status||"REFRESH_RESULT"===a.note.paragraphs[c].status||"RUNNING"===a.note.paragraphs[c].status){b=!0;break}return b},a.setLookAndFeel=function(b){a.note.config.looknfeel=b,a.setConfig(),f.$broadcast("setLookAndFeel",a.note.config.looknfeel)},a.setCronScheduler=function(b){a.note.config.cron=b,a.setConfig()},a.setConfig=function(b){b&&(a.note.config=b),g.updateNotebook(a.note.id,a.note.name,a.note.config)},a.sendNewName=function(){a.showEditor=!1,a.note.name&&g.updateNotebook(a.note.id,a.note.name,a.note.config)},f.$on("setNoteContent",function(b,c){a.paragraphUrl=d.paragraphId,a.asIframe=d.asIframe,a.paragraphUrl&&(c=l(a.paragraphUrl,c),console.log("### NOTEBOOK.JS -> setIframe"+a.asIframe),f.$broadcast("setIframe",a.asIframe)),a.note=c,null===a.note?k():m(c),f.$broadcast("setLookAndFeel",c.config.looknfeel)});var k=function(){a.note.config.looknfeel||(a.note.config.looknfeel="simple")},l=function(a,b){var c={};c.id=b.id,c.name=b.name,c.config=b.config,c.info=b.info,c.paragraphs=[];for(var d=0;d<b.paragraphs.length;d++)if(b.paragraphs[d].hasOwnProperty("id")&&b.paragraphs[d].id===a){c.paragraphs[0]=b.paragraphs[d],c.paragraphs[0].config||(c.paragraphs[0].config={}),c.paragraphs[0].config.editorHide=!0,c.paragraphs[0].config.tableHide=!1;break}return c};f.$on("moveParagraphUp",function(b,c){for(var d=-1,e=0;e<a.note.paragraphs.length;e++)if(a.note.paragraphs[e].id===c){d=e-1;break}0>d||d>=a.note.paragraphs.length||g.moveParagraph(c,d)}),f.$on("split",function(b,c){for(var d=-1,e=c.id,f=c.paragraph,h=0;h<a.note.paragraphs.length;h++)if(a.note.paragraphs[h].id===e){d=h+1;break}0>d||d>a.note.paragraphs.length||g.splitParagraph(d,e,f)}),f.$on("insertParagraph",function(b,c){for(var d=-1,e=0;e<a.note.paragraphs.length;e++)if(a.note.paragraphs[e].id===c){d=e+1;break}0>d||d>a.note.paragraphs.length||g.insertParagraph(d)}),f.$on("moveParagraphDown",function(b,c){for(var d=-1,e=0;e<a.note.paragraphs.length;e++)if(a.note.paragraphs[e].id===c){d=e+1;break}0>d||d>=a.note.paragraphs.length||g.moveParagraph(c,d)}),f.$on("moveFocusToPreviousParagraph",function(b,c){for(var d=!1,e=a.note.paragraphs.length-1;e>=0;e--)if(d===!1){if(a.note.paragraphs[e].id===c){d=!0;continue}}else{var g=a.note.paragraphs[e];if(!g.config.hide&&!g.config.editorHide&&!g.config.tableHide){f.$broadcast("focusParagraph",a.note.paragraphs[e].id);break}}}),f.$on("moveFocusToNextParagraph",function(b,c){for(var d=!1,e=0;e<a.note.paragraphs.length;e++)if(d===!1){if(a.note.paragraphs[e].id===c){d=!0;continue}}else{var g=a.note.paragraphs[e];if(!g.config.hide&&!g.config.editorHide&&!g.config.tableHide){f.$broadcast("focusParagraph",a.note.paragraphs[e].id);break}}}),a.removeNotebookResults=function(){console.log("removeNotebookResults"),g.resetResults()},a.saveNotebookStatus=function(){var b={};_.forEach(a.note.paragraphs,function(a,c){b[a.id]=a.text}),g.saveNote(b)};var m=function(b){b.name!==a.note.name&&(console.log("change note name: %o to %o",a.note.name,b.name),a.note.name=b.name),a.note.config=b.config,a.note.info=b.info;var c=b.paragraphs.map(function(a){return a.id}),d=a.note.paragraphs.map(function(a){return a.id}),e=c.length,g=d.length;if(e>g)for(var h in c)if(d[h]!==c[h]){a.note.paragraphs.splice(h,0,b.paragraphs[h]);break}if(e===g)for(var i in c){var j=b.paragraphs[i];if(d[i]===c[i])f.$broadcast("updateParagraph",{paragraph:j});else{var k=d.indexOf(c[i]);a.note.paragraphs.splice(k,1),a.note.paragraphs.splice(i,0,j),d=a.note.paragraphs.map(function(a){return a.id})}}if(g>e)for(var l in d)if(d[l]!==c[l]){a.note.paragraphs.splice(l,1);break}};a.changeDefaultInterpreter=function(b){a.settings.interpreter=b,f.$broadcast("changeDefaultInterpreter",b)}}]),angular.module("notebookWebApp").controller("ParagraphCtrl",["$scope","$rootScope","$route","$window","$http","$modal","$routeParams","$location","$timeout","websocketMsgSrv",function(a,b,c,d,e,f,g,h,i,j){a.paragraph=null,a.editor=null;var k={ingestion:"ace/mode/svg",shell:"ace/mode/text",crossdata:"ace/mode/xdql",streaming:"ace/mode/streaming",scala:"ace/mode/scala",sql:"ace/mode/sql",markdown:"ace/mode/markdown",cassandra:"ace/mode/lucene"};a.editorModeMap={},a.editorModeMap[k.ingestion]="ingestion",a.editorModeMap[k.shell]="shell",a.editorModeMap[k.crossdata]="crossdata",a.editorModeMap[k.streaming]="streaming",a.editorModeMap[k.sql]="spark-sql",a.editorModeMap[k.scala]="spark",a.editorModeMap[k.markdown]="markdown",a.editorModeMap[k.cassandra]="cassandra",a.forms={},a.init=function(b,c){a.paragraph=b,a.paragraph.noteId=c,a.chart={},a.colWidthOption=[1,2,3,4,5,6,7,8,9,10,11,12],a.showTitleEditor=!1,a.paragraph.config||(a.paragraph.config={}),l(),a.lastData||(a.lastData={}),"TABLE"===a.getResultType()?(a.lastData.settings=angular.copy(a.paragraph.settings),a.lastData.config=angular.copy(a.paragraph.config),a.loadTableData(a.paragraph.result),a.setGraphMode(a.getGraphMode(),!1,!1)):"HTML"===a.getResultType()&&a.renderHtml()},a.renderHtml=function(){var b=function(){if($("#p"+a.paragraph.id+"_html").length)try{$("#p"+a.paragraph.id+"_html").html(a.paragraph.result.msg)}catch(c){console.log("HTML rendering error %o",c)}else i(b,10)};i(b)};var l=function(){var b=a.paragraph.config;b.interpreter||(b.interpreter=a.editorModeMap[k.crossdata]),b.looknfeel||(b.looknfeel="default"),b.colWidth||(b.colWidth=12),b.graph||(b.graph={}),b.graph.mode||(b.graph.mode="table"),b.graph.height||(b.graph.height=300),b.graph.optionOpen||(b.graph.optionOpen=!1),b.graph.keys||(b.graph.keys=[]),b.graph.values||(b.graph.values=[]),b.graph.groups||(b.graph.groups=[])};a.getIframeDimensions=function(){if(a.asIframe){var b="#"+g.paragraphId+"_container",c=$(b).height();return c}return 0},a.$watch(a.getIframeDimensions,function(b,c){if(a.asIframe&&b){var e={};e.height=b,e.url=h.$$absUrl,d.parent.postMessage(angular.toJson(e),"*")}}),b.$on("updateParagraph",function(b,c){if(a.lastData.config=angular.copy(a.paragraph.config),a.lastData.settings=angular.copy(a.paragraph.settings),!(c.paragraph.id!==a.paragraph.id||c.paragraph.dateCreated===a.paragraph.dateCreated&&c.paragraph.dateFinished===a.paragraph.dateFinished&&c.paragraph.dateStarted===a.paragraph.dateStarted&&c.paragraph.status===a.paragraph.status&&c.paragraph.jobName===a.paragraph.jobName&&c.paragraph.title===a.paragraph.title&&c.paragraph.errorMessage===a.paragraph.errorMessage&&angular.equals(c.paragraph.settings,a.lastData.settings)&&angular.equals(c.paragraph.config,a.lastData.config))){var d=a.getResultType(),e=a.getResultType(c.paragraph),f=a.getGraphMode(),g=a.getGraphMode(c.paragraph),h=c.paragraph.dateFinished!==a.paragraph.dateFinished;a.paragraph.text!==c.paragraph.text&&(a.dirtyText?a.dirtyText===c.paragraph.text?(a.paragraph.text=c.paragraph.text,a.dirtyText=void 0):a.paragraph.text=a.dirtyText:a.paragraph.text=c.paragraph.text),a.paragraph.aborted=c.paragraph.aborted,a.paragraph.dateCreated=c.paragraph.dateCreated,a.paragraph.dateFinished=c.paragraph.dateFinished,a.paragraph.dateStarted=c.paragraph.dateStarted,a.paragraph.errorMessage=c.paragraph.errorMessage,a.paragraph.jobName=c.paragraph.jobName,a.paragraph.title=c.paragraph.title,"REFRESH_RESULT"===c.paragraph.status?a.paragraph.status="RUNNING":a.paragraph.status=c.paragraph.status,a.paragraph.result=c.paragraph.result,a.paragraph.settings=c.paragraph.settings,a.asIframe?(c.paragraph.config.editorHide=!0,c.paragraph.config.tableHide=!1,a.paragraph.config=c.paragraph.config):(a.paragraph.config=c.paragraph.config,l()),console.log(e),"TABLE"===e?(a.loadTableData(a.paragraph.result),("TABLE"!==d||h)&&(q(),r()),f!==g?a.setGraphMode(g,!1,!1):a.setGraphMode(g,!1,!0)):"HTML"===e&&a.renderHtml()}}),a.setInterpreter=function(b){a.paragraph.config.interpreter=b},a.isRunning=function(){return"RUNNING"===a.paragraph.status||"REFRESH_RESULT"===a.paragraph.status||"PENDING"===a.paragraph.status?!0:!1},a.cancelParagraph=function(){console.log("Cancel %o",a.paragraph.id),j.cancelParagraphRun(a.paragraph.id)},a.runParagraph=function(c){var d,e=a.editor.getSession().getValue();String(e).startsWith("%ing edit ")?(d=String(e).replace("%ing edit ",""),b.$broadcast("openPropertiesEditor",d)):String(e).startsWith("edit ")&&a.paragraph.config.interpreter===a.editorModeMap[k.ingestion]?(d=String(e).replace("edit ",""),b.$broadcast("openPropertiesEditor",d)):(j.runParagraph(a.paragraph.id,a.paragraph.title,c,a.paragraph.config,a.paragraph.settings.params),a.dirtyText=void 0)},a.moveUp=function(){b.$emit("moveParagraphUp",a.paragraph.id)},a.moveDown=function(){b.$emit("moveParagraphDown",a.paragraph.id)},a.insertNew=function(){b.$emit("insertParagraph",a.paragraph.id)},a.split=function(c){var d={id:a.paragraph.id,paragraph:c};b.$emit("split",d)},a.removeParagraph=function(){var b=confirm("Do you want to delete this paragraph?");b&&j.removeParagraph(a.paragraph.id)},a.toggleEditor=function(){a.paragraph.config.editorHide?a.openEditor():a.closeEditor()},a.closeEditor=function(){console.log("close the note");var b=angular.copy(a.paragraph.settings.params),c=angular.copy(a.paragraph.config);console.log("old config"),console.log(a.paragraph.config),console.log("new config"),c.editorHide=!0,console.log(c),j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,c,b)},a.openEditor=function(){console.log("open the note");var b=angular.copy(a.paragraph.settings.params),c=angular.copy(a.paragraph.config);console.log("old config"),console.log(a.paragraph.config),console.log("new config"),c.editorHide=!1,console.log(c),j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,c,b)},a.toggleOutput=function(){a.paragraph.config.tableHide?a.openTable():a.closeTable()},a.closeTable=function(){var b=angular.copy(a.paragraph.settings.params),c=angular.copy(a.paragraph.config);c.tableHide=!0,j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,c,b)},a.openTable=function(){var b=angular.copy(a.paragraph.settings.params),c=angular.copy(a.paragraph.config);c.tableHide=!1,j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,c,b)},a.showTitle=function(){var b=angular.copy(a.paragraph.settings.params),c=angular.copy(a.paragraph.config);c.title=!0,j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,c,b)},a.hideTitle=function(){var b=angular.copy(a.paragraph.settings.params),c=angular.copy(a.paragraph.config);c.title=!1,j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,c,b)},a.setTitle=function(){var b=angular.copy(a.paragraph.settings.params),c=angular.copy(a.paragraph.config);j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,c,b)},a.changeColWidth=function(){var b=angular.copy(a.paragraph.settings.params),c=angular.copy(a.paragraph.config);j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,c,b)},a.toggleGraphOption=function(){var b=angular.copy(a.paragraph.config);b.graph.optionOpen?b.graph.optionOpen=!1:b.graph.optionOpen=!0;var c=angular.copy(a.paragraph.settings.params);j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,b,c)},a.loadForm=function(b,c){var d=b.defaultValue;c[b.name]&&(d=c[b.name]),a.forms[b.name]=d},a.aceChanged=function(){a.dirtyText=a.editor.getSession().getValue();var b=a.editor.getSession().getValue();String(b).startsWith("%sql ")?(a.paragraph.config.interpreter=a.editorModeMap[k.sql],console.log(String(b)+" -> "+a.paragraph.config.interpreter)):String(b).startsWith("%ing ")?(a.paragraph.config.interpreter=a.editorModeMap[k.ingestion],console.log(String(b)+" -> "+a.paragraph.config.interpreter)):String(b).startsWith("%sh ")?(a.paragraph.config.interpreter=a.editorModeMap[k.shell],console.log(String(b)+" -> "+a.paragraph.config.interpreter)):String(b).startsWith("%md ")?(a.paragraph.config.interpreter=a.editorModeMap[k.markdown],console.log(String(b)+" -> "+a.paragraph.config.interpreter)):String(b).startsWith("%s ")?(a.paragraph.config.interpreter=a.editorModeMap[k.scala],console.log(String(b)+" -> "+a.paragraph.config.interpreter)):String(b).startsWith("%str ")?(a.paragraph.config.interpreter=a.editorModeMap[k.streaming],console.log(String(b)+" -> "+a.paragraph.config.interpreter)):String(b).startsWith("%xdql ")?(a.paragraph.config.interpreter=a.editorModeMap[k.crossdata],console.log(String(b)+" -> "+a.paragraph.config.interpreter)):String(b).startsWith("%cql ")&&(a.paragraph.config.interpreter=a.editorModeMap[k.cassandra],console.log(String(b)+" -> "+a.paragraph.config.interpreter))},a.aceLoaded=function(c){ace.require("ace/ext/language_tools"),ace.require("ace/range").Range;if(a.editor=c,"{{paragraph.id}}_editor"!==c.container.id){a.editor.renderer.setShowGutter(!1),a.editor.setHighlightActiveLine(!1),a.editor.focus();var d=a.editor.getSession().getScreenLength()*a.editor.renderer.lineHeight+a.editor.renderer.scrollBar.getWidth();m(c.container.id,d),a.editor.getSession().setMode(k.crossdata),a.editor.getSession().setUseWrapMode(!0),-1!==navigator.appVersion.indexOf("Mac")?a.editor.setKeyboardHandler("ace/keyboard/emacs"):-1!==navigator.appVersion.indexOf("Win")||-1!==navigator.appVersion.indexOf("X11")||-1!==navigator.appVersion.indexOf("Linux"),a.editor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!1,enableLiveAutocompletion:!1});a.editor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!1,enableLiveAutocompletion:!1}),a.handleFocus=function(b){a.paragraphFocused=b,i(function(){a.$digest()})},a.editor.on("focus",function(){a.handleFocus(!0)}),a.editor.on("blur",function(){a.handleFocus(!1)}),a.editor.getSession().on("change",function(b,e){d=e.getScreenLength()*a.editor.renderer.lineHeight+a.editor.renderer.scrollBar.getWidth(),m(c.container.id,d),a.editor.resize()});var e=function(b){for(var c in a.editorModeMap)if(a.editorModeMap[c]===b)return c};a.$watch(function(){return a.paragraph.config.interpreter},function(b,c){if(b!==c){var d=e(b);a.editor.getSession().setMode(d)}}),a.editor.commands.addCommand({name:"run",bindKey:{win:"Shift-Enter",mac:"Shift-Enter"},exec:function(b){var c=b.getValue();c&&a.runParagraph(c)},readOnly:!1}),a.editor.commands.bindKey("ctrl-space","startAutocomplete"),a.editor.commands.bindKey("ctrl-.",null),a.editor.keyBinding.origOnCommandKey=a.editor.keyBinding.onCommandKey,a.editor.keyBinding.onCommandKey=function(c,d,e){if(a.editor.completer&&a.editor.completer.activated);else{var f,g;38===e||80===e&&c.ctrlKey?(f=a.editor.getSession().getLength(),g=a.editor.getCursorPosition().row,0===g&&b.$emit("moveFocusToPreviousParagraph",a.paragraph.id)):(40===e||78===e&&c.ctrlKey)&&(f=a.editor.getSession().getLength(),g=a.editor.getCursorPosition().row,g===f-1&&b.$emit("moveFocusToNextParagraph",a.paragraph.id))}this.origOnCommandKey(c,d,e)}}};var m=function(a,b){$("#"+a).height(b.toString()+"px")};a.getEditorValue=function(){return a.editor.getValue()},a.getProgress=function(){return a.currentProgress?a.currentProgress:0},a.getExecutionTime=function(){var b=a.paragraph,c=Date.parse(b.dateFinished)-Date.parse(b.dateStarted);return"Took "+c/1e3+" seconds"},b.$on("updateProgress",function(b,c){c.id===a.paragraph.id&&(a.currentProgress=c.progress)}),b.$on("focusParagraph",function(b,c){a.paragraph.id===c&&(a.editor.focus(),$(".note-workspace").scrollTo("#"+c+"_editor",300,{offset:-60}),console.log("focusParagraph"))}),b.$on("runParagraph",function(b){a.runParagraph(a.editor.getValue())}),b.$on("openEditor",function(b){a.openEditor()}),b.$on("closeEditor",function(b){a.closeEditor()}),b.$on("openTable",function(b){a.openTable()}),b.$on("closeTable",function(b){a.closeTable()}),b.$on("changeDefaultInterpreter",function(b,c){a.changeDefaultInterpreter(c)}),a.changeDefaultInterpreter=function(b){var c=k.crossdata;switch(b){case"crossdata":c=k.crossdata;break;case"markdown":c=k.markdown;break;case"ingestion":c=k.ingestion;break;case"streaming":c=k.streaming;break;case"spark":c=k.scala;break;case"spark-sql":c=k.sql;break;case"shell":c=k.shell;break;default:c=k.crossdata}a.paragraph.config.interpreter=a.editorModeMap[c]},a.getResultType=function(b){var c=b?b:a.paragraph;return c.result&&c.result.type?c.result.type:"TEXT"},a.getBase64ImageSrc=function(a){return"data:image/png;base64,"+a},a.getGraphMode=function(b){var c=b?b:a.paragraph;return c.config.graph&&c.config.graph.mode?c.config.graph.mode:"table"},a.loadTableData=function(a){if(a&&"TABLE"===a.type){var b=[],c=[],d=[],e=a.msg.split("\n");a.comment="";for(var f=!1,g=0;g<e.length;g++){var h=e[g];if(f)a.comment+=h;else if(""!==h){for(var i=h.split("	"),j=[],k=[],l=0;l<i.length;l++){var m=i[l];0===g?b.push({name:m,index:l,aggr:"sum"}):(j.push(m),k.push({key:b[g]?b[g].name:void 0,value:m}))}0!==g&&(c.push(j),d.push(k))}else c.length>0&&(f=!0)}a.msgTable=d,a.columnNames=b,a.rows=c}},a.setGraphMode=function(b,c,d){if(c)n(b);else{q();var e=a.paragraph.config.graph.height;$("#p"+a.paragraph.id+"_graph").height(e),b&&"table"!==b?"multiBarChart"===b?p(b,a.paragraph.result,d):"pieChart"===b?p(b,a.paragraph.result,d):"stackedAreaChart"===b?p(b,a.paragraph.result,d):"lineChart"===b&&p(b,a.paragraph.result,d):o(a.paragraph.result,d)}};var n=function(b){var c=angular.copy(a.paragraph.config),d=angular.copy(a.paragraph.settings.params);c.graph.mode=b,j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,c,d)},o=function(b,c,d){var e=function(a){return isNaN(a)&&a.length>"%html".length&&"%html "===a.substring(0,"%html ".length)?"html":""},f=function(a){return a},g=function(){var b="";b+="<table class='table table-hover table-condensed'>",b+="  <thead>",b+="    <tr style='background-color: #F6F6F6; font-weight: bold;'>";for(var c in a.paragraph.result.columnNames)b+="<th>"+a.paragraph.result.columnNames[c].name+"</th>";b+="    </tr>",b+="  </thead>";for(var d in a.paragraph.result.msgTable){var g=a.paragraph.result.msgTable[d];b+="    <tr>";for(var h in g){var i=g[h].value;"html"!==e(i)&&(i=i.replace(/[\u00A0-\u9999<>\&]/gim,function(a){return"&#"+a.charCodeAt(0)+";"})),b+="      <td>"+f(i)+"</td>"}b+="    </tr>"}b+="</table>",$("#p"+a.paragraph.id+"_table").html(b),$("#p"+a.paragraph.id+"_table").perfectScrollbar();var j=a.paragraph.config.graph.height;$("#p"+a.paragraph.id+"_table").height(j)},h=function(){if($("#p"+a.paragraph.id+"_table").length)try{g()}catch(b){console.log("Chart drawing error %o",b)}else i(h,10)};i(h)},p=function(b,c,d){if(!a.chart[b]){var e=nv.models[b]();a.chart[b]=e}var f=s(c),g=(a.paragraph.config.graph.keys,a.paragraph.config.graph.values,[]);if("pieChart"===b){var h=t(f,!0).d3g;if(a.chart[b].x(function(a){return a.label}).y(function(a){return a.value}),h.length>0)for(var j=0;j<h[0].values.length;j++){var k=h[0].values[j];g.push({label:k.x,value:k.y})}}else if("multiBarChart"===b)g=t(f,!0).d3g,a.chart[b].yAxis.axisLabelDistance(50);else{var l=t(f),m=l.xLabels;g=l.d3g,a.chart[b].xAxis.tickFormat(function(a){return m[a]?m[a]:a}),a.chart[b].yAxis.axisLabelDistance(50),a.chart[b].useInteractiveGuideline(!0),a.chart[b].forceY([0])}var n=function(){var c=a.paragraph.config.graph.height,d=300,e=150;try{g[0].values.length>e&&(d=0)}catch(f){}d3.select("#p"+a.paragraph.id+"_"+b+" svg").attr("height",a.paragraph.config.graph.height).datum(g).transition().duration(d).call(a.chart[b]);d3.select("#p"+a.paragraph.id+"_"+b+" svg").style.height=c+"px",nv.utils.windowResize(a.chart[b].update)},o=function(){if(0!==$("#p"+a.paragraph.id+"_"+b+" svg").length)try{n()}catch(c){console.log("Chart drawing error %o",c)}else i(o,10)};i(o)};a.isGraphMode=function(b){return"TABLE"===a.getResultType()&&a.getGraphMode()===b?!0:!1},a.onGraphOptionChange=function(){q(),a.setGraphMode(a.paragraph.config.graph.mode,!0,!1)},a.removeGraphOptionKeys=function(b){a.paragraph.config.graph.keys.splice(b,1),q(),a.setGraphMode(a.paragraph.config.graph.mode,!0,!1)},a.removeGraphOptionValues=function(b){a.paragraph.config.graph.values.splice(b,1),q(),a.setGraphMode(a.paragraph.config.graph.mode,!0,!1)},a.removeGraphOptionGroups=function(b){a.paragraph.config.graph.groups.splice(b,1),q(),a.setGraphMode(a.paragraph.config.graph.mode,!0,!1)},a.setGraphOptionValueAggr=function(b,c){a.paragraph.config.graph.values[b].aggr=c,q(),a.setGraphMode(a.paragraph.config.graph.mode,!0,!1)};var q=function(){var b=function(a){for(var b=0;b<a.length;b++)for(var c=b+1;c<a.length;c++)angular.equals(a[b],a[c])&&a.splice(c,1)},c=function(b){for(var c=0;c<b.length;c++){for(var d=!1,e=0;e<a.paragraph.result.columnNames.length;e++){var f=b[c],g=a.paragraph.result.columnNames[e];if(f.index===g.index&&f.name===g.name){d=!0;break}}d||b.splice(c,1)}};b(a.paragraph.config.graph.keys),c(a.paragraph.config.graph.keys),c(a.paragraph.config.graph.values),b(a.paragraph.config.graph.groups),c(a.paragraph.config.graph.groups)},r=function(){0===a.paragraph.config.graph.keys.length&&a.paragraph.result.columnNames.length>0&&a.paragraph.config.graph.keys.push(a.paragraph.result.columnNames[0]),0===a.paragraph.config.graph.values.length&&a.paragraph.result.columnNames.length>1&&a.paragraph.config.graph.values.push(a.paragraph.result.columnNames[1])},s=function(b){for(var c=a.paragraph.config.graph.keys,d=a.paragraph.config.graph.groups,e=a.paragraph.config.graph.values,f={sum:function(a,b){var c=void 0!==a?isNaN(a)?1:parseFloat(a):0,d=void 0!==b?isNaN(b)?1:parseFloat(b):0;return c+d},count:function(a,b){var c=void 0!==a?a:0,d=void 0!==b?1:0;return c+d},min:function(a,b){var c=void 0!==a?isNaN(a)?1:parseFloat(a):0,d=void 0!==b?isNaN(b)?1:parseFloat(b):0;return Math.min(c,d)},max:function(a,b){var c=void 0!==a?isNaN(a)?1:parseFloat(a):0,d=void 0!==b?isNaN(b)?1:parseFloat(b):0;return Math.max(c,d)},avg:function(a,b,c){var d=void 0!==a?isNaN(a)?1:parseFloat(a):0,e=void 0!==b?isNaN(b)?1:parseFloat(b):0;return d+e}},g={sum:!1,count:!1,min:!1,max:!1,avg:!0},h={},i={},j=0;j<b.rows.length;j++){for(var k=b.rows[j],l=h,m=i,n=0;n<c.length;n++){var o=c[n];l[o.name]||(l[o.name]={order:n,index:o.index,type:"key",children:{}}),l=l[o.name].children;var p=k[o.index];m[p]||(m[p]={}),m=m[p]}for(var q=0;q<d.length;q++){var r=d[q],s=k[r.index];l[s]||(l[s]={order:q,index:r.index,type:"group",children:{}}),l=l[s].children,m[s]||(m[s]={}),m=m[s]}for(var t=0;t<e.length;t++){var u=e[t],v=u.name+"("+u.aggr+")";l[v]||(l[v]={type:"value",order:t,index:u.index}),m[v]?m[v]={value:f[u.aggr](m[v].value,k[u.index],m[v].count+1),count:g[u.aggr]?m[v].count+1:m[v].count}:m[v]={value:k[u.index],count:1}}}return{schema:h,rows:i}},t=function(b,c){var d=[],e=b.schema,f=b.rows,g=a.paragraph.config.graph.values,h=function(a,b){return a?a+"."+b:b},i=function(a,b,c,d,e,f,g,j){"key"===b.type?(f=h(f,a),g=h(g,c)):"group"===b.type?j=h(j,a):"value"===b.type&&(j=h(j,c),e(f,g,j,d));for(var k in b.children)if("group"!==b.type||a===c)for(var l in d)i(k,b.children[k],l,d[l],e,f,g,j);else i(k,b.children[k],k,void 0,e,f,g,j)},j=a.paragraph.config.graph.keys,k=a.paragraph.config.graph.groups;g=a.paragraph.config.graph.values;var l=0===j.length&&0===k.length&&g.length>0,m=Object.keys(e)[0],n={},o=0,p={},q=0,r={};for(var s in f)i(m,e[m],s,f[s],function(a,b,e,f){void 0===n[b]&&(r[o]=b,n[b]=o++),void 0===p[e]&&(p[e]=q++);var g=p[e];l&&(g=0),d[g]||(d[g]={values:[],key:l?"values":e});var h=isNaN(b)?c?b:n[b]:parseFloat(b),i=0;void 0===h&&(h=e),void 0!==f&&(i=isNaN(f.value)?0:parseFloat(f.value)/parseFloat(f.count)),d[g].values.push({
x:h,y:i})});var t={};for(var u in p){var v=u.substring(0,u.lastIndexOf("("));t[v]?t[v]++:t[v]=1}if(l)for(var w=0;w<d[0].values.length;w++){var u=d[0].values[w].x;if(u){var v=u.substring(0,u.lastIndexOf("("));t[v]<=1&&(d[0].values[w].x=v)}}else{for(var x=0;x<d.length;x++){var u=d[x].key,v=u.substring(0,u.lastIndexOf("("));t[v]<=1&&(d[x].key=v)}if(1===k.length&&1===g.length)for(x=0;x<d.length;x++){var u=d[x].key;u=u.split(".")[0],d[x].key=u}}return{xLabels:r,d3g:d}};a.setGraphHeight=function(){var b=$("#p"+a.paragraph.id+"_graph").height(),c=angular.copy(a.paragraph.settings.params),d=angular.copy(a.paragraph.config);d.graph.height=b,j.commitParagraph(a.paragraph.id,a.paragraph.title,a.paragraph.text,d,c)},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return this.slice(0,a.length)===a}),a.goToSingleParagraph=function(){console.log("### PARAGRAPH.JS -> goToSingleParagraph (active note) "+a.paragraph.noteId),console.log("### PARAGRAPH.JS -> goToSingleParagraph "+location.protocol+"//"+location.host+"/#/notebook/"+a.paragraph.noteId+"/paragraph/"+a.paragraph.id+"?asIframe");var b=location.protocol+"//"+location.host+"/#/notebook/"+a.paragraph.noteId+"/paragraph/"+a.paragraph.id+"?asIframe";d.open(b)}}]),angular.module("notebookWebApp").directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),angular.module("notebookWebApp").directive("dropdownInput",function(){return{restrict:"A",link:function(a,b){b.bind("click",function(a){a.stopPropagation()})}}}),angular.module("notebookWebApp").directive("resizable",function(){var a={autoHide:!0,handles:"se",minHeight:100,grid:[1e4,10]};return{restrict:"A",scope:{callback:"&onResize"},link:function(b,c){c.resizable(a),c.on("resizestop",function(){b.callback&&b.callback()})}}}),angular.module("notebookWebApp").directive("ngDelete",function(){return function(a,b,c){b.bind("keydown keypress",function(b){(27===b.which||46===b.which)&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),angular.module("notebookWebApp").service("baseUrlSrv",function(){this.getPort=function(){var a=Number(location.port);return a||(a=80,"https:"===location.protocol&&(a=443)),(3333===a||9e3===a)&&(a=8084),a+1},this.getWebsocketUrl=function(){var a="https:"===location.protocol?"wss:":"ws:";return a+"//"+location.hostname+":"+this.getPort()+"/ws"},this.getRestApiBase=function(){var a=Number(location.port);return("undefined"===a||0===a)&&(a=80,"https:"===location.protocol&&(a=443)),(3333===a||9e3===a)&&(a=8084),location.protocol+"//"+location.hostname+":"+a+"/api"}}),angular.module("notebookWebApp").factory("notebookListDataFactory",function(){var a={};return a.list=[],a.setNotes=function(b){a.list=angular.copy(b)},a}),angular.module("notebookWebApp").factory("websocketEvents",["$rootScope","$websocket","baseUrlSrv","$window","$routeParams",function(a,b,c,d,e){var f=d.location.href.indexOf("asIframe")>-1?!0:!1,g={};return g.ws=b(c.getWebsocketUrl()),g.ws.reconnectIfNotNormalClose=!0,g.ws.onOpen(function(){console.log("Websocket created"),a.$broadcast("setConnectedStatus",!0),setInterval(function(){g.sendNewEvent({op:"PING"})},6e4)}),g.sendNewEvent=function(a){console.log("Send >> %o, %o",a.op,a),g.ws.send(JSON.stringify(a))},g.isConnected=function(){return 1===g.ws.socket.readyState},g.ws.onMessage(function(b){var c;b.data&&(c=angular.fromJson(b.data)),console.log("Receive << %o, %o",c.op,c);var d=c.op,h=c.data;"NOTE"===d?a.$broadcast("setNoteContent",h.note):"NOTES_INFO"===d?(f&&g.sendNewEvent({op:"GET_NOTE",data:{id:e.noteId}}),a.$broadcast("setNoteMenu",h.notes)):"PARAGRAPH"===d?a.$broadcast("updateParagraph",h):"PROGRESS"===d?a.$broadcast("updateProgress",h):"COMPLETION_LIST"===d?a.$broadcast("completionList",h):("EXPORT_NOTE"===d||"IMPORT_NOTE"===d)&&alert(h.info)}),g.ws.onError(function(b){console.log("error message: ",b),a.$broadcast("setConnectedStatus",!1)}),g.ws.onClose(function(b){console.log("close message: ",b),a.$broadcast("setConnectedStatus",!1)}),g}]),angular.module("notebookWebApp").service("websocketMsgSrv",["$rootScope","websocketEvents",function(a,b){function c(){b.sendNewEvent({op:"NEW_NOTE"})}function d(a){b.sendNewEvent({op:"DEL_NOTE",data:{id:a}})}function e(){b.sendNewEvent({op:"LIST_NOTES"})}function f(a){b.sendNewEvent({op:"GET_NOTE",data:{id:a}})}function g(a,c,d){b.sendNewEvent({op:"NOTE_UPDATE",data:{id:a,name:c,config:d}})}function h(a,c){b.sendNewEvent({op:"MOVE_PARAGRAPH",data:{id:a,index:c}})}function i(a){b.sendNewEvent({op:"INSERT_PARAGRAPH",data:{index:a}})}function j(a){b.sendNewEvent({op:"CANCEL_PARAGRAPH",data:{id:a}})}function k(a,c,d){b.sendNewEvent({op:"SPLIT_INTO_PARAGRAPHS",data:{index:a,id:c,paragraph:d}})}function l(a,c){b.sendNewEvent({op:"EXPORT_NOTE",data:{id:a,filename:c}})}function m(a){b.sendNewEvent({op:"IMPORT_NOTE",data:{path:a}})}function n(a,c,d,e,f){b.sendNewEvent({op:"RUN_PARAGRAPH",data:{id:a,title:c,paragraph:d,config:e,params:f}})}function o(a){b.sendNewEvent({op:"PARAGRAPH_REMOVE",data:{id:a}})}function p(a,c,d,e,f){b.sendNewEvent({op:"COMMIT_PARAGRAPH",data:{id:a,title:c,paragraph:d,config:e,params:f}})}function q(){return b.isConnected()}function r(a){b.sendNewEvent({op:"SAVE_NOTE",data:{paragraphsText:a}})}function s(a){b.sendNewEvent({op:"RESET_RESULTS"})}var t={createNotebook:c,deleteNotebook:d,getNotebookList:e,getNotebook:f,runParagraph:n,updateNotebook:g,moveParagraph:h,insertParagraph:i,cancelParagraphRun:j,splitParagraph:k,exportNote:l,importNote:m,removeParagraph:o,commitParagraph:p,isConnected:q,saveNote:r,resetResults:s};return t}]),angular.module("Authentication").factory("AuthenticationService",["Base64","$http","$cookieStore","$rootScope","$timeout",function(a,b,c,d,e){var f={};return f.Login=function(a,b,c){e(function(){var d={success:"Stratio"===a&&"Stratio"===b};d.success||(d.message="Username or password is incorrect"),c(d)},1e3)},f.SetCredentials=function(e,f){var g=a.encode(e+":"+f);d.globals={currentUser:{username:e,authdata:g}},b.defaults.headers.common.Authorization="Basic "+g,c.put("globals",d.globals)},f.ClearCredentials=function(){d.globals={},c.remove("globals"),b.defaults.headers.common.Authorization="Basic "},f}]).factory("Base64",function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(b){var c,d,e,f,g,h="",i="",j="",k=0;do c=b.charCodeAt(k++),d=b.charCodeAt(k++),i=b.charCodeAt(k++),e=c>>2,f=(3&c)<<4|d>>4,g=(15&d)<<2|i>>6,j=63&i,isNaN(d)?g=j=64:isNaN(i)&&(j=64),h=h+a.charAt(e)+a.charAt(f)+a.charAt(g)+a.charAt(j),c=d=i="",e=f=g=j="";while(k<b.length);return h},decode:function(b){var c,d,e,f,g,h="",i="",j="",k=0,l=/[^A-Za-z0-9\+\/\=]/g;l.exec(b)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),b=b.replace(/[^A-Za-z0-9\+\/\=]/g,"");do e=a.indexOf(b.charAt(k++)),f=a.indexOf(b.charAt(k++)),g=a.indexOf(b.charAt(k++)),j=a.indexOf(b.charAt(k++)),c=e<<2|f>>4,d=(15&f)<<4|g>>2,i=(3&g)<<6|j,h+=String.fromCharCode(c),64!=g&&(h+=String.fromCharCode(d)),64!=j&&(h+=String.fromCharCode(i)),c=d=i="",e=f=g=j="";while(k<b.length);return h}}});